document.addEventListener("DOMContentLoaded", () => {
  // ==== Firebase verwijzingen ====
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ==== Globale state ====
  let currentUser = null;
  let currentUserRole = null;
  let messagesUnsub = null;
  let currentGroupId = "market";

  const GROUPS = [
    { id: "market",       label: "Market updates" },
    { id: "supplier-news", label: "Supplier news" },
    { id: "jobs-rfqs",    label: "Jobs & RFQs" }
  ];

  // ==== DOM referenties ====
  const authWrapper = document.getElementById("auth-wrapper");
  const app = document.getElementById("app");
  const loginTab = document.getElementById("login-tab");
  const signupTab = document.getElementById("signup-tab");
  const loginForm = document.getElementById("login-form");
  const signupForm = document.getElementById("signup-form");
  const loginError = document.getElementById("login-error");
  const signupError = document.getElementById("signup-error");
  const logoutBtn = document.getElementById("logout-btn");
  const userTag = document.getElementById("user-tag");
  const yearSpan = document.getElementById("year");

  const postForm = document.getElementById("post-form");
  const postText = document.getElementById("post-text");
  const postFile = document.getElementById("post-file");
  const postFeed = document.getElementById("post-feed");
  const groupList = document.getElementById("group-list");
  const currentGroupNameSpan = document.getElementById("current-group-name");

  const cartItemsEl = document.getElementById("cart-items");
  const cartEmptyMsgEl = document.getElementById("cart-empty-msg");
  const cartWeightEl = document.getElementById("cart-weight");
  const cartTotalEl = document.getElementById("cart-total");

  const shipForm = document.getElementById("shipping-form");
  const shipWeightInput = document.getElementById("ship-weight");
  const shipRegionInput = document.getElementById("ship-region");
  const summaryMaterialEl = document.getElementById("summary-material");
  const summaryShippingEl = document.getElementById("summary-shipping");
  const summaryTotalEl = document.getElementById("summary-total");

  yearSpan.textContent = new Date().getFullYear();

  // =========================
  // AUTH TABS
  // =========================
  loginTab.addEventListener("click", () => {
    loginTab.classList.add("active");
    signupTab.classList.remove("active");
    loginForm.classList.remove("hidden");
    signupForm.classList.add("hidden");
    loginError.textContent = "";
    signupError.textContent = "";
  });

  signupTab.addEventListener("click", () => {
    signupTab.classList.add("active");
    loginTab.classList.remove("active");
    signupForm.classList.remove("hidden");
    loginForm.classList.add("hidden");
    loginError.textContent = "";
    signupError.textContent = "";
  });

  // =========================
  // SIGNUP – rol opslaan (buyer/supplier)
  // =========================
  signupForm.addEventListener("submit", (e) => {
    e.preventDefault();
    signupError.textContent = "";

    const name = document.getElementById("signup-name").value.trim();
    const email = document.getElementById("signup-email").value.trim();
    const password = document.getElementById("signup-password").value;
    const roleInput = document.querySelector('input[name="signup-role"]:checked');
    const role = roleInput ? roleInput.value : "buyer";

    if (!name || !email || !password) {
      signupError.textContent = "Vul alle velden in.";
      return;
    }

    auth.createUserWithEmailAndPassword(email, password)
      .then((cred) => {
        // displayName instellen
        if (name) {
          cred.user.updateProfile({ displayName: name }).catch(() => {});
        }
        // user-document in Firestore
        return db.collection("users").doc(cred.user.uid).set({
          name: name,
          email: email,
          role: role,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      })
      .then(() => {
        signupForm.reset();
        loginTab.click(); // terug naar login-tab
      })
      .catch((err) => {
        console.error(err);
        signupError.textContent = err.message || "Account aanmaken mislukt.";
      });
  });

  // =========================
  // LOGIN
  // =========================
  loginForm.addEventListener("submit", (e) => {
    e.preventDefault();
    loginError.textContent = "";

    const email = document.getElementById("login-email").value.trim();
    const password = document.getElementById("login-password").value;

    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        loginForm.reset();
      })
      .catch((err) => {
        console.error(err);
        loginError.textContent = err.message || "Inloggen mislukt.";
      });
  });

  // =========================
  // LOGOUT
  // =========================
  logoutBtn.addEventListener("click", () => {
    auth.signOut().catch((err) => console.error(err));
  });

  // =========================
  // AUTH STATE LISTENER
  // =========================
  auth.onAuthStateChanged((user) => {
    currentUser = user;
    if (messagesUnsub) {
      messagesUnsub();
      messagesUnsub = null;
    }

    if (user) {
      authWrapper.classList.add("hidden");
      app.classList.remove("hidden");
      userTag.textContent = user.displayName || user.email || "Ingelogde gebruiker";

      // rol ophalen
      db.collection("users").doc(user.uid).get()
        .then((doc) => {
          const data = doc.data() || {};
          currentUserRole = data.role || "buyer";
        })
        .catch(() => {
          currentUserRole = "buyer";
        });

      initNavigation();
      initCart();
      initAnalyticsChart();
      initCommunityGroups();
      subscribeToMessages();
    } else {
      app.classList.add("hidden");
      authWrapper.classList.remove("hidden");
      userTag.textContent = "Demo user";
      currentUserRole = null;
    }
  });

  // =========================
  // NAVIGATIE (pages wisselen)
  // =========================
  function goToPage(pageId) {
    document.querySelectorAll(".page").forEach((section) => {
      section.classList.toggle("active-page", section.id === pageId);
    });

    document.querySelectorAll(".nav-btn").forEach((btn) => {
      btn.classList.toggle("active", btn.dataset.page === pageId);
    });
  }

  function initNavigation() {
    document.querySelectorAll("[data-page]").forEach((el) => {
      el.onclick = () => {
        const pageId = el.getAttribute("data-page");
        if (pageId) goToPage(pageId);
      };
    });

    goToPage("overview");
  }

  // =========================
  // WINKELMAND / STOCK
  // =========================
  const cart = [];

  function initCart() {
    const buttons = document.querySelectorAll(".add-to-cart");
    buttons.forEach((btn) => {
      btn.onclick = () => {
        const tr = btn.closest("tr");
        if (!tr) return;
        const dataStr = tr.getAttribute("data-item");
        if (!dataStr) return;

        try {
          const item = JSON.parse(dataStr);
          cart.push(item);
          renderCart();
        } catch (err) {
          console.error("Kan data-item niet parsen", err);
        }
      };
    });
    renderCart();
  }

  function renderCart() {
    if (!cartItemsEl) return;
    cartItemsEl.innerHTML = "";

    if (cart.length === 0) {
      if (cartEmptyMsgEl) cartEmptyMsgEl.style.display = "block";
    } else {
      if (cartEmptyMsgEl) cartEmptyMsgEl.style.display = "none";
    }

    let totalWeight = 0;
    let totalPrice = 0;

    cart.forEach((item) => {
      const li = document.createElement("li");
      const linePrice = (item.price || 0) * (item.weight || 0);
      li.textContent = `${item.name} – ${item.weight} kg × €${item.price.toFixed(2)}/kg = €${linePrice.toFixed(2)}`;
      cartItemsEl.appendChild(li);

      totalWeight += item.weight || 0;
      totalPrice += linePrice;
    });

    if (cartWeightEl) cartWeightEl.textContent = totalWeight.toFixed(1);
    if (cartTotalEl) cartTotalEl.textContent = totalPrice.toFixed(2);
    if (summaryMaterialEl) summaryMaterialEl.textContent = totalPrice.toFixed(2);

    if (shipWeightInput) {
      shipWeightInput.value = totalWeight.toFixed(1);
    }

    updateTotals();
  }

  // =========================
  // ANALYTICS (Chart.js)
  // =========================
  let stockChartInstance = null;

  function initAnalyticsChart() {
    const ctx = document.getElementById("stockChart");
    if (!ctx || typeof Chart === "undefined") return;

    if (stockChartInstance) {
      stockChartInstance.destroy();
    }

    stockChartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Carbon prepreg T700", "Epoxy hars 2K", "Glass fabric 450 g/m²"],
        datasets: [{
          label: "Stock (kg)",
          data: [1500, 3200, 7800]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // =========================
  // COMMUNITY – groepen
  // =========================
  function initCommunityGroups() {
    if (!groupList || !currentGroupNameSpan) return;
    groupList.innerHTML = "";

    GROUPS.forEach((group, index) => {
      const li = document.createElement("li");
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "group-btn" + (index === 0 ? " active" : "");
      btn.textContent = group.label;
      btn.dataset.groupId = group.id;
      btn.onclick = () => {
        currentGroupId = group.id;
        currentGroupNameSpan.textContent = group.label;
        document.querySelectorAll(".group-btn").forEach((b) => {
          b.classList.toggle("active", b === btn);
        });
        subscribeToMessages();
      };
      li.appendChild(btn);
      groupList.appendChild(li);
    });

    const firstGroup = GROUPS[0];
    currentGroupId = firstGroup.id;
    currentGroupNameSpan.textContent = firstGroup.label;
  }

  // =========================
  // COMMUNITY – berichten ophalen
  // =========================
  function subscribeToMessages() {
    if (!db || !postFeed) return;
    if (messagesUnsub) {
      messagesUnsub();
      messagesUnsub = null;
    }

    messagesUnsub = db.collection("messages")
      .where("groupId", "==", currentGroupId)
      .orderBy("createdAt", "desc")
      .limit(100)
      .onSnapshot((snapshot) => {
        postFeed.innerHTML = "";
        if (snapshot.empty) {
          const empty = document.createElement("div");
          empty.textContent = "Nog geen posts in deze groep.";
          empty.style.fontSize = "0.8rem";
          empty.style.color = "#9ca3af";
          postFeed.appendChild(empty);
          return;
        }

        snapshot.forEach((doc) => {
          const data = doc.data();
          const card = document.createElement("div");
          card.className = "post-card";

          const header = document.createElement("div");
          header.className = "post-header";

          const left = document.createElement("div");
          left.textContent = data.userName || "Onbekende gebruiker";

          const right = document.createElement("div");
          const parts = [];

          if (data.role === "buyer") {
            parts.push("Buyer");
          } else if (data.role === "supplier") {
            parts.push("Supplier");
          }

          if (data.createdAt && data.createdAt.toDate) {
            parts.push(data.createdAt.toDate().toLocaleString());
          }

          right.textContent = parts.join(" • ");

          header.appendChild(left);
          header.appendChild(right);

          const text = document.createElement("div");
          text.className = "post-text";
          text.textContent = data.text || "";

          card.appendChild(header);
          card.appendChild(text);

          if (data.fileUrl && data.fileName) {
            if (data.fileType === "image") {
              const img = document.createElement("img");
              img.src = data.fileUrl;
              img.alt = data.fileName;
              img.className = "post-image";
              card.appendChild(img);
            } else {
              const link = document.createElement("a");
              link.href = data.fileUrl;
              link.target = "_blank";
              link.rel = "noopener noreferrer";
              link.className = "post-file";
              link.textContent = data.fileName;
              card.appendChild(link);
            }
          }

          postFeed.appendChild(card);
        });
      }, (err) => {
        console.error("Fout bij ophalen messages:", err);
      });
  }

  // =========================
  // COMMUNITY – bericht plaatsen
  // =========================
  if (postForm) {
    postForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("Log in om een update te plaatsen.");
        return;
      }

      const text = postText.value.trim();
      const file = postFile.files[0];

      if (!text && !file) {
        alert("Typ een bericht of kies een bestand.");
        return;
      }

      try {
        let fileUrl = null;
        let fileName = null;
        let fileType = null;

        if (file) {
          fileName = file.name;
          const path = `community/${currentGroupId}/${Date.now()}_${file.name}`;
          const storageRef = storage.ref().child(path);
          const snapshot = await storageRef.put(file);
          fileUrl = await snapshot.ref.getDownloadURL();
          fileType = file.type && file.type.startsWith("image/") ? "image" : "file";
        }

        const groupDef = GROUPS.find((g) => g.id === currentGroupId) || GROUPS[0];

        await db.collection("messages").add({
          text: text,
          groupId: currentGroupId,
          groupName: groupDef.label,
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email,
          role: currentUserRole || "buyer",
          fileUrl: fileUrl,
          fileName: fileName,
          fileType: fileType,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        postText.value = "";
        postFile.value = "";
      } catch (err) {
        console.error("Plaatsen mislukt:", err);
        alert("Plaatsen mislukt: " + (err.message || "onbekende fout"));
      }
    });
  }

  // =========================
  // CHECKOUT / VERZENDKOSTEN
  // =========================
  function calculateShipping(region, weight) {
    if (!weight || weight <= 0) return 0;
    let base = 0;
    let per10 = 0;

    if (region === "NL") {
      base = 7;
      per10 = 4;
    } else if (region === "EU") {
      base = 15;
      per10 = 8;
    } else {
      base = 25;
      per10 = 12;
    }
    const extraSteps = Math.max(0, Math.ceil(weight / 10) - 1);
    return base + extraSteps * per10;
  }

  function updateTotals() {
    const material = parseFloat(summaryMaterialEl ? summaryMaterialEl.textContent : "0") || 0;
    const region = shipRegionInput ? shipRegionInput.value : "NL";
    const weight = parseFloat(shipWeightInput ? shipWeightInput.value : "0") || 0;
    const shipping = calculateShipping(region, weight);

    if (summaryShippingEl) summaryShippingEl.textContent = shipping.toFixed(2);
    if (summaryTotalEl) summaryTotalEl.textContent = (material + shipping).toFixed(2);
  }

  if (shipForm) {
    shipForm.addEventListener("submit", (e) => {
      e.preventDefault();
      updateTotals();
    });
  }
  if (shipRegionInput) {
    shipRegionInput.addEventListener("change", updateTotals);
  }
  if (shipWeightInput) {
    shipWeightInput.addEventListener("input", updateTotals);
  }
});
